#!/bin/bash
#--------------------------------------------------------
#   Don't remove this section for credits
#   Don't rename this file
#--------------------------------------------------------
#   This script to add loadbalance mwan3 configurations
#   by Helmi Amirudin a.k.a helmiau
#   my profile page https://wwww.helmiau.com
#   my github https://github.com/helmiau
#--------------------------------------------------------

clear
echo "  helmilb_log : Helmi Loadbalance setup will be start in 7 secs."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed.."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed..."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed...."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed....."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed......."
sleep 1
clear
echo "  helmilb_log : Helmi Loadbalance setup will be installed........."
sleep 1

# Add my Load Balance settings to default config mwan3
if [[ $(grep -c 'mueth1\|mueth2\|mueth3\|mueth4' /etc/config/mwan3) = "0" ]];then
	echo "  helmilb_log : my load balance settings is not available, patching..."
	cat << "EOF" > /etc/config/mwan3
config rule 'default_rule'
	option dest_ip '0.0.0.0/0'
	option use_policy 'balanced'

config globals 'globals'
	option mmx_mask '0x3F00'
	option rtmon_interval '5'
	option local_source 'none'

config policy 'balanced'
	option last_resort 'unreachable'
	list use_member 'mueth1'
	list use_member 'mueth2'
	list use_member 'mueth3'
	list use_member 'mueth4'
	list use_member 'mwwan'

config interface 'ueth1'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth2'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth3'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'ueth4'
	option enabled '1'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'

config interface 'wwan'
	option initial_state 'online'
	list track_ip '0.0.0.0'
	option family 'ipv4'
	option track_method 'ping'
	option reliability '1'
	option check_quality '0'
	option keep_failure_interval '1'
	option timeout '5'
	option interval '3'
	option failure_interval '3'
	option recovery_interval '1'
	option down '5'
	option up '5'
	option count '4'
	option size '24'
	option enabled '0'

config member 'mueth1'
	option interface 'ueth1'
	option metric '1'
	option weight '1'

config member 'mueth2'
	option interface 'ueth2'
	option metric '1'
	option weight '1'

config member 'mueth3'
	option interface 'ueth3'
	option metric '1'
	option weight '1'

config member 'mueth4'
	option interface 'ueth4'
	option metric '1'
	option weight '1'

config member 'mwwan'
	option interface 'wwan'
	option metric '1'
	option weight '1'

EOF
	echo "  helmilb_log : patching mwan3 done..."
else
	echo "  helmilb_log : mwan3 config file already patched. Skipping..."
fi

# Add my Load Balance network interfaces to default network config
if [[ $(grep -c 'ueth1\|ueth2\|ueth3\|ueth4' /etc/config/network) = "0" ]];then
	echo "  helmilb_log : network config file available, patching..."
	cat << "EOF" >> /etc/config/network


config interface 'ueth1'
	option proto 'dhcp'
	option ifname 'eth1'
	option metric '10'

config interface 'ueth2'
	option proto 'dhcp'
	option ifname 'eth2'
	option metric '20'

config interface 'ueth3'
	option proto 'dhcp'
	option ifname 'eth3'
	option metric '30'

config interface 'ueth4'
	option proto 'dhcp'
	option ifname 'eth4'
	option metric '40'

config interface 'wwan'
	option proto 'dhcp'
	option metric '50'

EOF
	echo "  helmilb_log : patching network for my loadbalance settings is done..."
else
	echo "  helmilb_log : network config file already patched. Skipping..."
fi

# Add my Load Balance network interfaces to firewall
if [[ $(grep -c 'fweth1\|fweth2\|fweth3\|fweth4' /etc/config/firewall) = "0" ]];then
	echo "  helmilb_log : firewall config file available, patching..."
	cat << "EOF" >> /etc/config/firewall


config zone
	option name 'fweth1'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth1'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config zone
	option name 'fweth2'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth2'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config zone
	option name 'fweth3'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth3'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config zone
	option name 'fweth4'
	option forward 'REJECT'
	option output 'ACCEPT'
	option network 'ueth4'
	option input 'REJECT'
	option masq '1'
	option mtu_fix '1'

config forwarding
	option dest 'fweth1'
	option src 'lan'

config forwarding
	option dest 'fweth2'
	option src 'lan'

config forwarding
	option dest 'fweth3'
	option src 'lan'

config forwarding
	option dest 'fweth4'
	option src 'lan'

EOF
	echo "  helmilb_log : patching firewall config file done..."
else
	echo "  helmilb_log : firewall config file already patched. Skipping..."
fi

# Add my Load Balance wan network interfaces to firewall
if [[ $(grep -c "option name 'wan'\|option dest 'wan'" /etc/config/firewall) = "1" ]];then
	echo "  helmilb_log : firewall for wwan is unset, patching..."
	cat << "EOF" >> /etc/config/firewall

config forwarding
	option dest 'wan'
	option src 'lan'

EOF
	echo "  helmilb_log : patching firewall firewall for wwan done..."
else
	echo "  helmilb_log : firewall for wwan already patched. Skipping..."
fi

echo "  helmilb_log : Installation done..."
sleep 1
